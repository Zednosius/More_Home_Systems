namespace = mhs_durin

# Sets country flag for empire starting in DurinÂ´s Forge System
event = {
    id = mhs_durin.1
    hide_window = yes
    is_triggered_only = yes
    immediate = {
        every_country = {
			limit = {
				any_system_within_border = {
					has_star_flag = mhs_durinsforge_system
				}
			}
			set_country_flag = mhs_durinsforge_system
		}
    }
}

# Fired when home system is surveyed
ship_event = {
    id = mhs_durin.2	# was 3
    title = "mhs_durin.2.name"
    desc = "mhs_durin.2.desc"
    picture = GFX_evt_ship_in_orbit
	target = THIS
	
    is_triggered_only = yes

	trigger = {
        owner = {
            has_country_flag = mhs_durinsforge_system
        }
        solar_system = {
            has_star_flag = mhs_durinsforge_system
        }
    }
	
    immediate = {
		
		solar_system = {
			remove_star_flag = mhs_durinsforge_system
			set_star_flag = mhs_durinsforge_system_surveyed
		}
		owner = {
            begin_event_chain = {
                event_chain = "mhs_durins_hall"
            }
			closest_system = {
				limit = { has_star_flag = mhs_durinsforge_system_surveyed }
				spawn_system = {
					min_distance = 20
					max_distance = 70
					initializer = "mhs_durinshall_system"
				}
			}
            closest_system = {
                limit = { 
					has_star_flag = mhs_durins_hall_system
					NOT = {
						has_star_flag = mhs_durins_hall_system_used
					}
				}
                save_event_target_as = durins_hall_system
				set_star_flag = mhs_durins_hall_system_used
            }
            create_point_of_interest = {
                id = durins_hall.1
                name = durins_hall.1.name
                desc = durins_hall.1.desc
                event_chain = mhs_durins_hall
                location = event_target:durins_hall_system
            }
        }
    }
	
	option = {
		name = mhs_durin.2.a
	}
}

# Fired when durins hall is visited
ship_event = {
    id = mhs_durin.3
    title = "mhs_durin.3.name"
    desc = "mhs_durin.3.desc"
	is_triggered_only = yes    
	
    trigger = {
        FROM = { # system
            has_star_flag = mhs_durins_hall_system
        }
        owner = { # Country
            has_event_chain = mhs_durins_hall
            NOT = {
                has_country_flag = mhs_has_found_durins_hall
            }
        }
    }
    
    immediate = {
		owner = {
			remove_country_flag = mhs_durins_hall_found
		}
        FROM = { # system
            random_system_planet = {
                limit = { has_planet_flag = mhs_durins_hall_khazad_dum }
                save_event_target_as = khazad_dum
            }
        }

        owner = {
            set_country_flag = mhs_has_found_durins_hall
            remove_point_of_interest = durins_hall.1

            create_point_of_interest = {
                id = durins_hall.2
                name = durins_hall.2.name
                desc = durins_hall.2.desc
                event_chain = mhs_durins_hall
                location = event_target:khazad_dum
            }
        }
    }
	
	option = {
		name = mhs_durin.3.a
	}
}

#Fired when khazad dum is surveyed
ship_event = {
    id = mhs_durin.4
    title = "mhs_durin.4.name"
    desc = "mhs_durin.4.desc"
    picture = GFX_evt_ship_in_orbit
    is_triggered_only = yes
    location = from
    trigger = {
        FROM = { #planet
            has_planet_flag = mhs_durins_hall_khazad_dum
        }
        owner = { # Country
            has_event_chain = mhs_durins_hall
        }
    }
    immediate = {
        owner = {
            remove_point_of_interest = durins_hall.2
        }
    }
    option = {
        name = mhs_durin.4.a
        enable_special_project = {
            name = "KHAZAD_DUM_EXPEDITION_PROJECT"
            owner = root.owner
            location = from
        }

    }
}

#Fired when the expedition project is completed
ship_event = {
    id = mhs_durin.5
    title = "mhs_durin.5.name"
    desc = "mhs_durin.5.desc"
    picture = GFX_evt_archaeological_dig
    location = from
    is_triggered_only = yes

    immediate = {
        # FromFromFrom is the planet
        FromFromFrom = { # planet
            save_event_target_as = khazad_dum
            change_pc = pc_mhs_durin_nuked_colonize

			every_tile = {
				limit = { has_blocker = no has_building = no }
				set_blocker = tb_city_ruins
				random_resources = yes
			}
			random_tile = {
				remove_blocker = yes
			}
        }
        owner = {
			create_point_of_interest = {
				id = durins_hall.3
				name = durins_hall.3.name
				desc = durins_hall.3.desc
				event_chain = mhs_durins_hall
				location = event_target:khazad_dum
			}
            remove_point_of_interest = durins_hall.2
        }
		create_fleet = {}
		last_created_fleet = {
			set_owner = root.owner
			create_ship = {
				name = random
				random_existing_design = "colonizer"
			}
			set_location = event_target:khazad_dum
		}
    }
	
	option = {
		name = mhs_durin.5.a
		hidden_effect = {
			owner = {
				abort_special_project = {
					type = "KHAZAD_DUM_EXPEDITION_PROJECT"
					location = event_target:khazad_dum
				}
			}
		}
	}
}

#Planet is colonized by player
country_event = {
	id = mhs_durin.6
	hide_window = yes
	
	trigger = {
		has_event_chain = mhs_durins_hall
		NOT = {
			has_country_flag = mhs_khazad_dum_colonized
		}
		any_owned_planet = {
			has_planet_flag = mhs_durins_hall_khazad_dum
		}
	}
	immediate = {
		set_country_flag = mhs_khazad_dum_colonized
		random_owned_planet = {
			limit = {
				has_planet_flag = mhs_durins_hall_khazad_dum
			}
			planet_event = {
				id = mhs_durin.7
			}
		}
	}
}

planet_event = {
    id = mhs_durin.7
    title = "mhs_durin.7.name"
    desc = "mhs_durin.7.desc"
	location = ROOT
	is_triggered_only = yes

    trigger = {
		has_planet_flag = mhs_durins_hall_khazad_dum
    }
    immediate = {
        owner = {
            create_point_of_interest = {
                id = durins_hall.4
                name = durins_hall.4.name
                desc = durins_hall.4.desc
                event_chain = mhs_durins_hall
                location = ROOT
            }
            remove_point_of_interest = durins_hall.3
        }
    }
}

#Last Tileblocker removed. Entrance to the Depth found
planet_event = {
    id = mhs_durin.8
    title = "mhs_durin.8.name"
    desc = "mhs_durin.8.desc"
    is_triggered_only = yes
    trigger = {
        owner = { # Country
            has_event_chain = mhs_durins_hall
			NOT = {
				has_country_flag = mhs_durins_hall_khazad_dum_blocker
			}
        }
		has_planet_flag = mhs_durins_hall_khazad_dum
        not = {
            any_tile = {
                has_blocker = yes
                not = {
                    is_same_value = from
                }
            }
        }
    }
    immediate = {
        owner = {
			set_country_flag = mhs_durins_hall_khazad_dum_blocker
            remove_point_of_interest = durins_hall.4
			enable_special_project = {
				name = "KHAZAD_DUM_DEEPS_EXPEDITION_PROJECT"
				owner = root.owner
				location = ROOT
			}
        }
        from = { #tile
            set_building = "building_power_plant_1" # Replace with the right building
        }
    }
}

# Expedition leads to Attack

planet_event = {
    id = mhs_durin.9
    title = "mhs_durin.9.name"
    desc = "mhs_durin.9.desc"
    show_sound = event_air_raid_siren
	location = ROOT
	
	is_triggered_only = yes
    
	trigger = {
        owner = { # Country
            has_event_chain = mhs_durins_hall
        }
    }
    
	immediate = {
        create_country = {
            name = "Underground Horrors"
            type = faction
			effect = {
				establish_communications_no_message = root.owner
			}
			flag = {
                icon = {
                    category = "pirate"
                    file = "flag_pirate_10.dds"
                }
                background= {
                    category = "backgrounds"
                    file = "new_dawn.dds"
                }
                colors = {
                    "red"
                    "black"
                    "null"
                    "null"
                }
			}	
		}
		create_species = {
			name = "Ancient Horrors"
			class = random
			portrait = random
			traits = random
		}
		create_army = {
			name = "Ancient Horrors"
			owner = last_created
			type = "mhs_ancient_horros"
		}
		create_army = {
			name = "Ancient Horrors"
			owner = last_created
			type = "mhs_ancient_horros"
		}
		create_army = {
			name = "Ancient Horrors"
			owner = last_created
			type = "mhs_ancient_horros"
		}
        last_created_country = {
            save_global_event_target_as = underground_horrors
        }
    }
}

#Lost to Ancient Horrors

# attack win
# This = country, leader attacker
# From = country, planet owner
# FromFrom = planet
country_event = {
    id = mhs_durin.10
    title = "mhs_durin.10.name"
    desc = "mhs_durin.10.desc"
    is_triggered_only = yes
    trigger = {
        fromfrom = { #planet
            #Is the right planet
            has_planet_flag = mhs_durins_hall_khazad_dum
            #Owner of the planet has event chain
            owner = { # Country
                has_event_chain = mhs_durins_hall
            }
        }
        #Attackers are horrors
        is_same_value = event_target:underground_horrors
    }
    immediate = {
        fromfrom = { # planet
            planet_event = {
                id = mhs_durin.14 #Start the rolling purge
                days = 14
            }
        }
        from = { # country
            country_event = {
                id = mhs_durin.11 # Inform player about what will happen when the horrors are controlling the planet
                days = 14
            }
        }
    }
}

# Inform player about what will happen when the horrors are controlling the planet
country_event = {
    id = mhs_durin.11
    title = "mhs_durin.11.name"
    desc = "mhs_durin.11.desc"
    is_triggered_only = yes
}

#Defended against Ancient Horrors

# defend win
# This = country, planet owner
# From = country, attack leader
# FromFrom = planet
country_event = {
    id = mhs_durin.12
    title = "mhs_durin.12.name"
    desc = "mhs_durin.12.desc"
    is_triggered_only = yes
    trigger = {
        fromfrom = { #planet
            has_planet_flag = mhs_durins_hall_khazad_dum
            owner = { # Country
                has_event_chain = mhs_durins_hall
				NOT = {
					has_country_flag = KHAZAD_DUM_DEEPS_RETALIATION_PROJECT
				}
            }
        }
    }
	immediate = {
		random_owned_planet = {
			limit = {
				has_planet_flag = mhs_durins_hall_khazad_dum
			}
			enable_special_project = {
				name = "KHAZAD_DUM_DEEPS_RETALIATION_PROJECT"
				owner = ROOT
				location = THIS
			}
        }
	}
}

#Reconquest against Horrors

# This = country, leader attacker
# From = country, planet owner
# FromFrom = planet
country_event = {
    id = mhs_durin.13
    title = "mhs_durin.13.name"
    desc = "mhs_durin.13.desc"
    is_triggered_only = yes
    trigger = {
        fromfrom = { #planet
            has_planet_flag = mhs_durins_hall_khazad_dum
            owner = { # Country
                has_event_chain = mhs_durins_hall
                is_same_value = root
				NOT = {
					has_country_flag = mhs_durins_hall_khazad_dum_retaliation
				}
            }
        }
    }
    immediate = {
        #Stop the purging which is in progress
        every_owned_pop = {
            purge = no
        }
		random_owned_planet = {
			limit = {
				has_planet_flag = mhs_durins_hall_khazad_dum
			}
			enable_special_project = {
				name = "KHAZAD_DUM_DEEPS_RETALIATION_PROJECT"
				owner = ROOT
				location = THIS
			}
        }	
    }
}

# Purgeing is initiated

# Every month start purging one more pop until there is only one left
# Then give an event to the owner telling them about the pop fortifying their position.
planet_event = {
    id = mhs_durin.14
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_planet_flag = mhs_durins_hall_khazad_dum
        controller = {
            is_same_value = event_target:underground_horrors
        }
    }
    immediate = {
        IF = {
            limit = { 
                count_pops = {
                    limit = { 
						is_being_purged = no
						is_growing = no
					}
					count > 1
                } 
            }
            random_pop = {
                limit = { is_being_purged = no }
                purge = yes
            }
            planet_event = {
                id = mhs_durin.14 #Re fire this event in a month
                days = 30
             }

        else = {
            owner = {
                country_event = { id = mhs_durin.15 } # The last pop has fortified their position.
                }
            }
        }
    }
}

# The last pop has fortified their position.
country_event = {
    id = mhs_durin.15
    title = "mhs_durin.15.name"
    desc = "mhs_durin.15.desc"
    is_triggered_only = yes
}

# Assault of the Underground
planet_event = {
    id = mhs_durin.16
    title = "mhs_durin.16.name"
    desc = "mhs_durin.16.desc"
    show_sound = event_air_raid_siren
	location = ROOT
	
	is_triggered_only = yes
    
	trigger = {
        owner = { # Country
            has_event_chain = mhs_durins_hall
        }
    }
    
	immediate = {
		set_country_flag = mhs_durins_hall_khazad_dum_retaliation
		create_army = {
			name = "Ancient Horrors"
			owner = underground_horrors
			type = "mhs_ancient_horros"
		}
		create_army = {
			name = "Ancient Horrors"
			owner = underground_horrors
			type = "mhs_ancient_horros"
		}
		create_army = {
			name = "Ancient Horrors"
			owner = underground_horrors
			type = "mhs_ancient_horros"
		}
		create_army = {
			name = "Ancient Horrors"
			owner = underground_horrors
			type = "mhs_ancient_horros"
		}
		create_army = {
			name = "Ancient Horrors"
			owner = underground_horrors
			type = "mhs_ancient_horros"
		}
		create_army = {
			name = "Ancient Horrors"
			owner = underground_horrors
			type = "mhs_ancient_horros"
		}
    }
}

#Defended against Ancient Horrors

# defend win
# This = country, planet owner
# From = country, attack leader
# FromFrom = planet
country_event = {
    id = mhs_durin.17
    title = "mhs_durin.17.name"
    desc = "mhs_durin.17.desc"
    is_triggered_only = yes
    trigger = {
        fromfrom = { #planet
            has_planet_flag = mhs_durins_hall_khazad_dum
            owner = { # Country
                has_event_chain = mhs_durins_hall
				has_country_flag = mhs_durins_hall_khazad_dum_retaliation
            }
        }
    }
	option = {
		name = mhs_durin.17.a
		random_owned_planet = {
			limit = {
				has_planet_flag = mhs_durins_hall_khazad_dum
			}
			enable_special_project = {
				name = "KHAZAD_DUM_RESTORATION_PROJECT"
				owner = ROOT
				location = THIS
			}
        }
	}
}

#Reconquest against Horrors

# This = country, leader attacker
# From = country, planet owner
# FromFrom = planet
country_event = {
    id = mhs_durin.18
    title = "mhs_durin.17.name"
    desc = "mhs_durin.17.desc"
    is_triggered_only = yes
    trigger = {
        fromfrom = { #planet
            has_planet_flag = mhs_durins_hall_khazad_dum
            owner = { # Country
                has_event_chain = mhs_durins_hall
                is_same_value = root
				has_country_flag = mhs_durins_hall_khazad_dum_retaliation
            }
        }
    }
    immediate = {
        #Stop the purging which is in progress
        every_owned_pop = {
            purge = no
        }
    }
	
	option = {
		name = mhs_durin.18.a
		random_owned_planet = {
			limit = {
				has_planet_flag = mhs_durins_hall_khazad_dum
			}
			enable_special_project = {
				name = "KHAZAD_DUM_RESTORATION_PROJECT"
				owner = ROOT
				location = THIS
			}
        }
	}
}

# Atmospheric Renewer repaired
planet_event = {
    id = mhs_durin.19
    title = "mhs_durin.19.name"
    desc = "mhs_durin.19.desc"
	location = ROOT
	
	is_triggered_only = yes
    
	trigger = {
        owner = { # Country
            has_event_chain = mhs_durins_hall
        }
    }
	
	option = {
		name = mhs_durin.19.a
		hidden_effect = {
			planet_event = { id = mhs_durin.20 days = 5 random = 0 } # 1800 days (5 years) +- 60
		}
	}	
}

# Atmosphere Restored
planet_event = {
    id = mhs_durin.20
    title = "mhs_durin.20.name"
    desc = "mhs_durin.20.desc"
	location = ROOT
	
	is_triggered_only = yes
    
	trigger = {
        owner = { # Country
            has_event_chain = mhs_durins_hall
        }
    }
	
	immediate = {
		change_pc = ideal_planet_class
		set_planet_flag = mhs_durins_hall_khazad_dum_restored
	}
}

# Plans to repair the planetary ringstructure presented
planet_event = {
    id = mhs_durin.21
    title = "mhs_durin.21.name"
    desc = "mhs_durin.21.desc"
	location = ROOT
	
	is_triggered_only = yes
    
	trigger = {
		has_planet_flag = mhs_durins_hall_khazad_dum_restored
        owner = { # Country
            has_event_chain = mhs_durins_hall
        }
    }
	
	mean_time_to_happen = {
		days = 5	# should be 2000
	}
	
	option = {
		name = mhs_durin.21.a
		random_owned_planet = {
			limit = {
				has_planet_flag = mhs_durins_hall_khazad_dum
			}
			enable_special_project = {
				name = "KHAZAD_DUM_RING_RECONSTRUCTION_PROJECT"
				owner = ROOT
				location = THIS
			}
        }
	}
}